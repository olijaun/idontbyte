<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A layout example that shows off a blog page with a list of posts.">
    <title>Event Sourcing - Clean Architecture</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-"
          crossorigin="anonymous">

    <!--[if lte IE 8]>
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css">
    <!--<![endif]-->


    <!--[if lte IE 8]>
    <link rel="stylesheet" href="css/layouts/blog-old-ie.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="/assets/blog.css">
    <!--<![endif]-->

    <link rel="me" href="https://twitter.com/oliverjaun" />
    <link rel="me" href="https://github.com/olijaun" />
    <link rel="me" href="mailto:oliver@jaun.org" />

    <link rel="webmention" href="https://webmention.io/idontbyte.jaun.org/webmention" />
    <link rel="pingback" href="https://webmention.io/idontbyte.jaun.org/xmlrpc" />

    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-50141806-2', 'auto');
        ga('send', 'pageview');

    </script>

</head>


<body>

<div id="layout" class="pure-g">

    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <h1 class="brand-title">I don't byte</h1>
        <h2 class="brand-tagline">Oliver Jaun's Blog On Software Development</h2>

        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="pure-button" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="/about.html">About</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

    <div class="content pure-u-1 pure-u-md-3-4">
        <!-- A single blog post -->
        <section class="post">

            <header class="post-header">

                <h2 class="post-title">Event Sourcing - Clean Architecture</h2>

                <p class="post-meta">
                    By <a class="post-anchor" href="/about">Oliver Jaun</a>,
                    
                    <time datetime='2020-03-22'>Mar 22, 2020</time>
                    

                    


                    
                    <a class="post-category post-category-architecture" href="#">architecture</a>
                    
                    <a class="post-category post-category-design" href="#">design</a>
                    
                    <a class="post-category post-category-eventsourcing" href="#">eventsourcing</a>
                    
                </p>
            </header>

            <div class="post-description">
                <p>
                    <p>This is the fourth part in a series about Event Sourcing. In the past year I was involved in the development of a Java application using Event Sourcing. Actually we did it twice using different approaches. In this post I’d like to share some thoughts about Event Stores. See also my other post on Event Sourcing:</p>

<p>This post assumes that you know what Event Sourcing is. If not then I recommend that you read <a href="https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf">this Document from Greg Young</a>.</p>

<h1 id="what-is-clean-architecture">What is Clean Architecture?</h1>

<p>I really enjoyed Robert C. Martin’s Book on Clean Architecture. Also his <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">blog post</a> on the same topic is quite interesting. Hexagonal Architecture, Onion Architecture etc. are all similar: Instead of having a layered architecture where each layer must depend only on the layer below they propose an architecture where the domain model is in the center and the UI, Database etc. depend on the domain model and not vice versa.</p>

<p><img src="/assets/clean_arch.png" alt="My helpful screenshot" /></p>

<p>Robert C. Martin says:</p>

<blockquote>
  <p>The outermost layer is generally composed of frameworks and tools such as the Database, the Web Framework, etc. […] This layer is where all the details go. The Web is a detail. The database is a detail. We keep these things on the outside where they can do little harm.</p>
</blockquote>

<p>Let’s make an example comparing it to the Layered Architecture. Remember <a href="https://en.wikipedia.org/wiki/Data_access_object">Data Access Objects (DAOs)</a>?</p>

<p><img src="/uml/0bd0e5bb408a929a40d40425711b0908.svg" alt="PlantUML SVG diagram" class="plantuml" /></p>

<p>So here the Business Logic depends on the infrastructure (the lower layer). With Clean Architecture this changes to:</p>

<p><img src="/uml/04141ee12cbba40fe6a5a7993d99aee1.svg" alt="PlantUML SVG diagram" class="plantuml" /></p>

<p>Note that I changed DAO to Repository to emphasize that the Repository is nothing “technical”. However this is not the main point. The main point is that the Interface <code class="highlighter-rouge">MyRepository</code> is now in the <code class="highlighter-rouge">org.jaun.app.buisiness</code> package and the infrastructure implements it.</p>

<h1 id="clean-architecture-for-event-sourcing">Clean Architecture for Event Sourcing</h1>

<p>Clean Architecture means that frameworks like Spring, JPA, etc. are a detail. You should not use them in your domain. You can use them in your infrastructure code however. Some people won’t like this idea. It means that you cannot use all your fancy <code class="highlighter-rouge">@Autowired</code> annotations etc. However it does not mean that you cannot use <a href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>. Dependency injection does not require annotations!</p>

<p>In respect to Event Sourcing this means that you don’t want a dependency on the framework you’re using for Event Sourcing from your domain model.</p>

<p>Let’s have a look at <a href="https://axoniq.io/">Axon</a> for example. Axon provides a framework for eventsources applications. Here’s an example aggregate (taken from <a href="https://docs.axoniq.io/reference-guide/implementing-domain-logic/command-handling/aggregate">their web page</a>):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.axonframework.commandhandling.CommandHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.axonframework.eventsourcing.EventSourcingHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.axonframework.modelling.command.AggregateIdentifier</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">axonframework</span><span class="o">.</span><span class="na">modelling</span><span class="o">.</span><span class="na">command</span><span class="o">.</span><span class="na">AggregateLifecycle</span><span class="o">.</span><span class="na">apply</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GiftCard</span> <span class="o">{</span>

    <span class="nd">@AggregateIdentifier</span> <span class="c1">// 1.</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@CommandHandler</span> <span class="c1">// 2.</span>
    <span class="kd">public</span> <span class="nf">GiftCard</span><span class="o">(</span><span class="nc">IssueCardCommand</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 3.</span>
       <span class="n">apply</span><span class="o">(</span><span class="k">new</span> <span class="nc">CardIssuedEvent</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="na">getCardId</span><span class="o">(),</span> <span class="n">cmd</span><span class="o">.</span><span class="na">getAmount</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="nd">@EventSourcingHandler</span> <span class="c1">// 4.</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">on</span><span class="o">(</span><span class="nc">CardIssuedEvent</span> <span class="n">evt</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="na">getCardId</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 5.</span>
    <span class="kd">protected</span> <span class="nf">GiftCard</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
    <span class="c1">// omitted command handlers and event sourcing handlers</span>
<span class="o">}</span>
</code></pre></div></div>

<p>As you can see this depends on Axon Annotations in order to work. The aggregate is part of the domain model. It should not depend on a framework. The framework should be a detail. It should be possible to replace Axon with something else without touching the domain model.</p>

                </p>
            </div>
        </section>

        


<div id="disqus_thread"></div>
<script>

    var disqus_config = function () {
        this.page.url = "http://idontbyte.jaun.org/blog/2020/03/eventsourcing-clean-architecture";  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = "/blog/2020/03/eventsourcing-clean-architecture"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//idontbyte-jaun-org.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



        

<div class="footer">
    <div class="pure-menu pure-menu-horizontal">
        &copy; 2019, 2020 - Oliver Jaun
        <ul>
            <li class="pure-menu-item"><a href="/privacy_policy.html" class="pure-menu-link">Privacy Policy</a></li>
            <li class="pure-menu-item"><a href="/disclosure_statement.html" class="pure-menu-link">Disclosure Statement</a></li>
        </ul>
    </div>
</div>
    </div>



</div>


</body>

</html>